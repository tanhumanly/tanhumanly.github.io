<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teamable Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/boltcss/bolt.min.css" />
    <link href="https://cdn.tailwindcss.com" rel="stylesheet" />
    <style>
      main {
        padding: 2rem;
      }
      .status {
        border: 1px solid gray;
        padding: 0.5rem;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <main>
      <div>
        <label for="login_hint">Login Hint</label>
        <input type="text" id="login_hint" value="tan@humanly.io"/>
      </div>

      <div>
        <button type="button" id="google">Link calendar with Google</button>
        <button type="button" id="microsoft">
          Link calendar with Microsoft
        </button>
      </div>
      <br />

      <div id="calendar"></div>

      <div>
        <button type="button" id="connectable" disabled title="Require OAuth linked">
          List Connectable Calendars
        </button>
        <button type="button" id="connect" disabled title="Require OAuth linked">Connect first entry</button>
        <button type="button" id="disconnect" disabled title="Require OAuth linked">Disconnect</button>
      </div>

      <div id="connectable_entries"></div>
    </main>

    <script>
      const popout = async function (url) {
        return new Promise((resolve, reject) => {
          const popup = window.open(url, null, "width=500,height=700");
          window.addEventListener("message", function (msg) {
            popup.close();
            console.log(msg)

            if (msg && msg.data && msg.data.payload && msg.data.payload.connected) {
              enable('connectable');
            } else {
              disable('connectable');
            }

            getCalendar().then(renderCalendar);
            resolve(msg.data);
          });

          setTimeout(function () {
            popup.close();
            reject("Timeout");
          }, 150000);
        });
      };

      function getLoginHint() {
        return encodeURIComponent(document.getElementById("login_hint").value);
      }

      function disable(id) {
        document.getElementById(id).disabled = true;
      }

      function enable(id) {
        document.getElementById(id).disabled = false;
      }

      function shortenString(str, maxLength = 16) {
        if (str.length > maxLength) {
          return str.substring(0, maxLength) + '...';
        } else {
          return str;
        }
      }

      function renderCalendar(calendar) {
        let status = '';
      
        if (calendar.type === 'google' && calendar.connected === false) {
          status = "Google OAuth linked, not connected";
        } else if (calendar.type === 'microsoft' && calendar.connected === false) {
          status = "Microsoft OAuth linked, not connected";
        } else if (calendar.type === null) {
          status = "No OAuth linked";
        } else if (calendar.type === 'google' && calendar.connected === true) {
          status = "Google calendar connected";
        } else if (calendar.type === 'microsoft' && calendar.connected === true) {
          status = "Microsoft calendar connected";
        }

        if(calendar.connected) {
          enable('disconnect')
        } else {
          disable('disconnect');
        }
      
        document.getElementById('calendar').innerHTML = `
          <h2>Calendar</h2>
          <div>
            <p class="status"><strong>Status:</strong> ${status}</p>
            <p><strong>Connected:</strong> ${calendar.connected}</p>
            <p><strong>Identifier:</strong> ${calendar.identifier && shortenString(calendar.identifier)}</p>
            <p><strong>Label:</strong> ${calendar.label}</p>
            <p><strong>Type:</strong> ${calendar.type}</p>
          </div>
        `;
      }

      function renderConnectableEntries(entries) {
        const container = document.getElementById('connectable_entries');
        
        if (entries.length === 0) {
          container.innerHTML = `
            <h2>Connectable Entries</h2>
            <p>No entries available.</p>
          `;
          return;
        }
        
        const list = entries.map(entry => `
          <li>
            <strong>Label:</strong> ${entry.label} <br>
            <strong>Primary:</strong> ${entry.primary} <br>
            <strong>Identifier:</strong> ${shortenString(entry.identifier)}
          </li>
        `).join('');
        
        container.innerHTML = `
          <h2>Connectable Entries</h2>
          <ul>
            ${list}
          </ul>
        `;
      }
      

      const origin = encodeURIComponent(window.location.href);
      // const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RzK2FwcEBodW1hbmx5LmlvIiwiZXhwIjoyMzE4MDc2MDAzLCJ0ZWFtX2lkIjo2NiwidXNlcl91dWlkIjoiOGI5MzE3ZjYtNDMzYy00NjMxLWE0YmItMDE4ZjY1MDI3MTBkIn0.Ms0F8w_fpH_c0QKee2bm5YIW0lKV2-zrY9LNAOvxbp8";
      // const API_HOST = "https://local.api.internal.humanly.io:4004";

      const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRhbkBodW1hbmx5LmlvIiwiZXhwIjoyMzE5MjkwODA2LCJ0ZWFtX2lkIjo2NiwidXNlcl91dWlkIjoiOGI5MzE3ZjYtNDMzYy00NjMxLWE0YmItMDE4ZjY1MDI3MTBkIn0.mL-s5WFQrgdX-2uuGfIFvXpSNC5LC97XGP3IXtcOGog";
      const API_HOST = 'https://tan-api.internal.humanly.dev'
      let connectable_entries = [];
      renderConnectableEntries(connectable_entries);

      document.getElementById("google").addEventListener("click", function () {
        getOAuthUrl("google")
        .then(({url}) => {
          if (url) { popout(url) }
          else { throw 'url is not returned' }
        })
        .then(function (msg) {
          console.log("Received pop up results", msg);
        });
      });

      document
        .getElementById("microsoft")
        .addEventListener("click", function () {
          getOAuthUrl("microsoft")
          .then(({url}) => popout(url))
          .then(function (msg) {
            console.log("Received pop up results", msg);
          });
        });

      const headers = new Headers({
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`, // replace with your token
      });

      async function getCalendar() {
        return fetch(`${API_HOST}/calendar/`, { headers }).then(function (res) {
          return res.json();
        });
      }

      async function getOAuthUrl(provider) {
        return fetch(`${API_HOST}/calendar/oauth/${provider}?login_hint=${getLoginHint()}`, { headers }).then(function (res) {
          return res.json();
        });
      }

      async function getConnectableCalendars() {
        return fetch(`${API_HOST}/calendar/connectable/`, { headers }).then(
          function (res) {
            return res.json();
          }
        );
      }

      async function connectCalendar(identifier) {
        return fetch(`${API_HOST}/calendar/${identifier}`, {
          headers,
          method: "POST",
        }).then(function (res) {
          return res.json();
        });
      }

      async function disconnectCalendar() {
        return fetch(`${API_HOST}/calendar`, {
          headers,
          method: "DELETE",
        }).then(function (res) {
          return res.json();
        });
      }

      document.addEventListener("DOMContentLoaded", function() {
        getCalendar().then(data => {
          console.log({data});
          renderCalendar(data);
        })
      });

      document
        .getElementById("connectable")
        .addEventListener("click", function () {
          getConnectableCalendars().then(function (data) {
            connectable_entries = data.entries;
            renderConnectableEntries(data.entries);
            if(data.entries.length > 0) {
              enable('connect');
            } else {
              disable('connect');
            }
            console.log("Connectable entries", data);
          });
        });

      document.getElementById("connect").addEventListener("click", function () {
        connectCalendar(connectable_entries[0].identifier).then(function (
          data
        ) {
          console.log("Connect results", data);
          renderCalendar(data);
          if(data.connected) {
            enable('disconnect');
          } else {
            disable('disconnect');
          }
        });
      });

      document
        .getElementById("disconnect")
        .addEventListener("click", function () {
          disconnectCalendar().then(function (data) {
            console.log("Disconnect results", data);
            renderCalendar(data);
            if(!data.connected) {
              disable('connect');
              disable('connectable');
              renderConnectableEntries([]);
            }
          });
        });
    </script>
  </body>
</html>
